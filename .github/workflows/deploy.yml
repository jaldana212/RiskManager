name: Deploy CAP to SAP BTP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Cloud Foundry CLI v7 (SAP compatible)
        run: |
          curl -L https://packages.cloudfoundry.org/stable?release=debian64 -o cf-cli.deb
          sudo dpkg -i cf-cli.deb
          cf version

      - name: Install CF MTA Plugin
        run: |
          cf add-plugin-repo CF-Community https://plugins.cloudfoundry.org
          cf install-plugin multiapps -f

      - name: Install CDS Development Kit
        run: npm install -g @sap/cds-dk

      - name: Install MTA Build Tool
        run: npm install -g mbt

      - name: Install project dependencies
        run: npm ci

      - name: Login to Cloud Foundry
        run: |
          cf login \
            -a ${{ secrets.CF_API }} \
            -u ${{ secrets.CF_USERNAME }} \
            -p ${{ secrets.CF_PASSWORD }} \
            -o ${{ secrets.CF_ORG }} \
            -s ${{ secrets.CF_SPACE }}

      - name: Build MTA
        run: |
          export PATH=$PATH:$(npm root -g)/@sap/cds-dk/bin
          cds --version
          mbt build

      - name: List MTA archive
        run: ls -lh mta_archives

      - name: Deploy to SAP BTP
        run: cf deploy mta_archives/*.mtar -f
